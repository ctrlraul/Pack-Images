const filesInput=document.getElementById("input"),selectImagesButton=document.getElementById("select-images-button"),imageOutputContainer=document.getElementById("image-output-container"),efficiencyViewOutputContainer=document.getElementById("efficiency-view-output-container"),downloadMapJSONButton=document.getElementById("download-map-json"),downloadMapJSONFormattedButton=document.getElementById("download-map-json-formatted"),sizeOutput=document.getElementById("size-output"),efficiencyOutput=document.getElementById("efficiency-output"),hiddenElements=document.getElementsByClassName("hidden");function createImage(t,e){const n=document.createElement("canvas"),o=n.getContext("2d");n.width=t.w,n.height=t.h;for(const t of e)o.drawImage(t.img,t.x,t.y,t.w,t.h);return n}function createEfficiencyView(t,e){const n=document.createElement("canvas"),o=n.getContext("2d");let a=1,i=1;t.w>t.h?i=t.h/t.w:a=t.w/t.h,n.width=512*a,n.height=512*i,o.fillStyle="#000000",o.fillRect(0,0,n.width,n.height);for(const n of e)o.fillStyle=`hsl(${360*Math.random()}, 100%, 70%)`,o.fillRect(n.x/t.w*512,n.y/t.h*512,n.w/t.w*512,n.h/t.h*512);return n}function createMap(t){const e={};for(const n of t)e[n.name]={width:n.w,height:n.h,x:n.x,y:n.y};return e}function downloadJSON(t,e,n=!1){const o=document.createElement("a"),a=n?JSON.stringify(t,null,'\t'):JSON.stringify(t);o.href="data:text/json;charset=utf-8,"+encodeURIComponent(a),o.download=e+".json",o.click()}function potpack(t){for(var e=0,n=0,o=0,a=t;o<a.length;o+=1){var i=a[o];e+=i.w*i.h,n=Math.max(n,i.w)}t.sort(function(t,e){return e.h-t.h});for(var c=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),n),h:1/0}],l=0,d=0,u=0,h=t;u<h.length;u+=1)for(var r=h[u],m=c.length-1;m>=0;m--){var f=c[m];if(!(r.w>f.w||r.h>f.h)){if(r.x=f.x,r.y=f.y,d=Math.max(d,r.y+r.h),l=Math.max(l,r.x+r.w),r.w===f.w&&r.h===f.h){var s=c.pop();m<c.length&&(c[m]=s)}else r.h===f.h?(f.x+=r.w,f.w-=r.w):r.w===f.w?(f.y+=r.h,f.h-=r.h):(c.push({x:f.x+r.w,y:f.y,w:f.w-r.w,h:r.h}),f.y+=r.h,f.h-=r.h);break}}return{w:l,h:d,fill:e/(l*d)||0}}selectImagesButton.addEventListener("click",()=>input.click()),filesInput.addEventListener("input",()=>{const t=[],e=filesInput.files.length;for(const n of filesInput.files){const o=document.createElement("img");o.addEventListener("load",()=>{if(t.push({img:o,name:n.name,w:o.naturalWidth,h:o.naturalHeight}),t.length===e){const e=potpack(t),n=createImage(e,t),o=createEfficiencyView(e,t),a=createMap(t);for(;imageOutputContainer.lastChild;)imageOutputContainer.lastChild.remove();for(imageOutputContainer.append(n);efficiencyViewOutputContainer.lastChild;)efficiencyViewOutputContainer.lastChild.remove();efficiencyViewOutputContainer.append(o),downloadMapJSONButton.onclick=(()=>{downloadJSON(a,"map")}),downloadMapJSONFormattedButton.onclick=(()=>{downloadJSON(a,"map",!0)}),sizeOutput.textContent=e.w+"x"+e.h,efficiencyOutput.textContent=Math.round(1e4*e.fill)/100+"%";for(const t of Array.from(hiddenElements))t.classList.remove("hidden")}}),o.src=URL.createObjectURL(n)}});